;; PgBouncer configuration for NextJS Stripe Payment Template
;; Security-hardened connection pooling for PostgreSQL
;; PCI DSS compliant configuration

[databases]
payment_template_dev = host=postgres port=5432 dbname=payment_template_dev
payment_template_prod = host=postgres port=5432 dbname=payment_template_prod

[pgbouncer]

;; Connection pooling configuration
listen_addr = 0.0.0.0
listen_port = 6432

;; Pool configuration - optimized for payment processing workloads
pool_mode = transaction
max_client_conn = 200
default_pool_size = 25
min_pool_size = 5
reserve_pool_size = 5

;; Connection limits to prevent DoS attacks
max_db_connections = 100
max_user_connections = 50

;; Authentication security
auth_type = scram-sha-256
auth_file = /etc/pgbouncer/userlist.txt
auth_query = SELECT username, password FROM public.pgbouncer_auth WHERE username = $1

;; Security timeouts
server_lifetime = 3600
server_idle_timeout = 600
client_idle_timeout = 0
client_login_timeout = 60
query_timeout = 0
query_wait_timeout = 120

;; SSL/TLS Configuration for secure connections
server_tls_sslmode = require
server_tls_ca_file = /etc/ssl/certs/ca-certificates.crt
server_tls_protocols = secure
server_tls_ciphers = ECDHE+AESGCM:ECDHE+CHACHA20:DHE+AESGCM:DHE+CHACHA20:!aNULL:!MD5:!DSS

client_tls_sslmode = allow
client_tls_ca_file = /etc/ssl/certs/ca-certificates.crt
client_tls_protocols = secure
client_tls_ciphers = ECDHE+AESGCM:ECDHE+CHACHA20:DHE+AESGCM:DHE+CHACHA20:!aNULL:!MD5:!DSS

;; Security logging and monitoring
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1
syslog = 1
syslog_facility = daemon
syslog_ident = pgbouncer

;; Performance and security tuning
tcp_keepalive = 1
tcp_keepidle = 600
tcp_keepintvl = 30
tcp_keepcnt = 3

;; Prevent connection hijacking
server_reset_query = DISCARD ALL
server_check_delay = 30

;; Resource limits for security
max_packet_size = 2147483647
pkt_buf = 4096
listen_backlog = 128

;; Statistics and monitoring
stats_period = 60
stats_users = postgres,pgbouncer_monitor

;; Security features
ignore_startup_parameters = extra_float_digits,search_path

;; Admin configuration
admin_users = pgbouncer_admin