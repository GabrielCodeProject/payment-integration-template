# pgBackRest Configuration for NextJS Stripe Payment Template
# Advanced backup management for production-grade PostgreSQL
# Author: Backend Reliability Engineer
# Version: 1.0.0

# ============================================================================
# GLOBAL CONFIGURATION
# ============================================================================

[global]
# Repository configuration
repo1-type=posix
repo1-path=/var/lib/postgresql/backups/pgbackrest
repo1-retention-full=7
repo1-retention-diff=3
repo1-retention-incr=3

# Encryption for sensitive payment data
repo1-cipher-type=aes-256-cbc
repo1-cipher-pass=payment_template_backup_key_2024

# Compression
repo1-compress-type=gz
repo1-compress-level=6

# Archive settings
archive-async=y
archive-get-queue-max=1GB
archive-push-queue-max=1GB

# Logging
log-level-console=info
log-level-file=debug
log-path=/var/lib/postgresql/backups/pgbackrest/log
log-timestamp=n

# Process settings
process-max=4
compress-level-network=3

# Repository storage and safety
repo1-hardlink=n
repo1-block=y
backup-standby=n

# Checksum settings
checksum-page=y
delta=y

# Network settings
tcp-keep-alive=y

# ============================================================================
# STANZA CONFIGURATION
# ============================================================================

[payment-template]
# PostgreSQL cluster settings
pg1-host=postgres
pg1-host-user=postgres
pg1-path=/var/lib/postgresql/data
pg1-port=5432
pg1-socket-path=/var/run/postgresql

# Database connection
pg1-host-cmd-ssh-config=/etc/ssh/ssh_config
pg1-host-config-include-path=/etc/postgresql/postgresql.conf
pg1-host-config-path=/etc/postgresql

# Backup settings specific to this stanza
backup-standby=n
start-fast=y

# Archive command integration
archive-mode-check=y

# Recovery settings
recovery-option=primary_conninfo=host=postgres port=5432 user=replica
recovery-option=standby_mode=on
recovery-option=restore_command=pgbackrest --stanza=payment-template archive-get %f "%p"

# ============================================================================
# DEVELOPMENT OVERRIDES
# ============================================================================

# Development-specific settings (override for production)
db-timeout=30
protocol-timeout=60
spool-path=/tmp/pgbackrest

# Disable some safety checks for development
checksum-page=n
resume=n

# ============================================================================
# BACKUP SCHEDULE DEFINITIONS
# ============================================================================

# Full backup: Weekly on Sunday at 1 AM
# Differential backup: Daily at 2 AM (except Sunday)
# Incremental backup: Every 6 hours

# Note: Actual scheduling is handled by cron jobs or systemd timers
# These settings define the backup behavior when triggered